<?php



// Function to save all image to loac directory for wordpress 'security' reasons.
/*
foreach ( $feed_array as $feed_me ){
	
	$xml = simplexml_load_file("http://www.dose.ca/scripts/feeds/fullatomfeed.ashx?id=".$feed_me);
	
	foreach ($xml->entry as $x) {
	
		foreach ( $x-> link as $linktype ){
	
			if ( $linktype['type'] == 'image/jpeg' ){
			
				$image_bin = str_replace ( '.bin', '', jb_featureimage ( $linktype['href'] ) );
				$image_caption = $linktype['title'];
			}
	
		}


	
	
		$url = 'http://app.canada.com/SouthPARC/mobile.svc/Binary/'.$image_bin.'?.jpg';
		$img = $image_bin.'.jpg';
		file_put_contents($img, file_get_contents($url));
}	



*/










function jb_slugs( $title ){

$slugme = str_replace(' ', '-', $title);
$slugme = str_replace('\'', '', $slugme);
$slugme = str_replace('"', '', $slugme);
$slugme = str_replace(',', '', $slugme);
$slugme = str_replace('!', '', $slugme);
$slugme = str_replace('(', '', $slugme);
$slugme = str_replace(')', '', $slugme);
$slugme = str_replace('.', '', $slugme);
$slugme = str_replace('----', '', $slugme);
$slugme = str_replace('---', '', $slugme);
$slugme = str_replace('--', '', $slugme);
$slugme = str_replace('--', '', $slugme);
$slugme = str_replace(':', '', $slugme);
$slugme = str_replace('?', '', $slugme);
return $slugme;

}



function jb_puncfree( $title ){

$slugme = str_replace('\'', '', $title);
$slugme = str_replace('"', '', $slugme);
$slugme = str_replace(',', '', $slugme);
$slugme = str_replace('!', '', $slugme);
$slugme = str_replace('(', '', $slugme);
$slugme = str_replace(')', '', $slugme);
$slugme = str_replace('.', '', $slugme);
$slugme = str_replace(':', '', $slugme);
$slugme = str_replace('â€™', '', $slugme);
$slugme = str_replace('?', '', $slugme);


return $slugme;

}








function jb_postid($sourcelink) {
	
	
	$myid = preg_split ('/content=/', $sourcelink );
	return $myid[1];
	
	
}



function jb_featureimage($enclosure_link) {
	
	$myimage = str_replace('http://www2.dose.ca/', '', $enclosure_link );
	return $myimage;
		
}























// , '2043528'

// good ones -- , '2043436', '959893', '2043465', '981251', '960850', '977134', '2040180', '2043524', '960290', '960585', '2043533', '2040386', '4412352', '981388'
global $feed_array;
$feed_array = array('2040443');


$author_id = 10;
$category_id = 10;
$tag_id = 10;

foreach ( $feed_array as $feed_me ){

echo '<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0"
	xmlns:excerpt="http://wordpress.org/export/1.1/excerpt/"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:wp="http://wordpress.org/export/1.1/"
>

<channel>


	<title>dose content</title>

	<link>http://localhost</link>

	<description>Just another WordPress site</description>

	<pubDate>?updated?</pubDate>

	<language>en</language>
	<wp:wxr_version>1.1</wp:wxr_version>
	<wp:base_site_url>http://localhost</wp:base_site_url>
	<wp:base_blog_url>http://localhost</wp:base_blog_url>
	
	
	';



$xml = simplexml_load_file("http://www.dose.ca/scripts/feeds/fullatomfeed.ashx?id=".$feed_me);





/**
 * Setup the authors for this blog
 */
 
 
	/*
	 
	 <wp:author>
		<wp:author_id>$id</wp:author_id>
		<wp:author_login>strtolower( add dashes( $name ) )</wp:author_login>
		<wp:author_email>$email</wp:author_email>
		<wp:author_display_name><![CDATA[$name]]></wp:author_display_name>
		<wp:author_first_name><![CDATA[ strtolower ( split ( $name, 1 ) ) ]]></wp:author_first_name>
		<wp:author_last_name><![CDATA[ strtolower ( split ( $name, 1 ) ) ]]></wp:author_last_name>
	</wp:author>
	
	
	*/
 
 
global $author_array;

$author_array = array();



foreach ($xml->entry as $x) {

	foreach ($x->author as $author) {
		
		foreach ($author->name as $a_name) {
		
		$insert = $a_name;
		
		array_push( $author_array, $insert  );
		//$author_id ++;
		
		}
	
	}

}

$author_array = array_unique($author_array);


foreach ( $author_array as $author => $aname){

	if ( $aname!='' ){
	
	$firstlast = explode (' ', $aname);
	
	}
	else{
	
	$placeholder = 'Dose Dotca';
	$firstlast = explode (' ', $placeholder);
	
	}

	//echo $first .' last='. $last;
	//exit();
	echo "<wp:author>\n\n";
	
	echo "<wp:author_id>".$author_id."</wp:author_id>\r\n";
	echo		"<wp:author_login>".  strtolower($firstlast[0].$firstlast[1]) ."</wp:author_login>\r\n";
	echo 		"<wp:author_email>".$author_id."@number.com</wp:author_email>\r\n";
	echo 		"<wp:author_display_name><![CDATA[ ". $firstlast[0].' '.$firstlast[1] ." ]]></wp:author_display_name>\r\n";
	echo 		"<wp:author_first_name><![CDATA[ ". strtolower ( $firstlast[0] )." ]]></wp:author_first_name>\r\n";
	echo 		"<wp:author_last_name><![CDATA[ ".strtolower ( $firstlast[1] )." ]]></wp:author_last_name>\r\n";
	
	echo "</wp:author>\r\n\n";
	
	$author_id++;
	
}








/**
 * Setup the Categories
 */




global $category_array;

$category_array = array();




foreach ($xml->entry as $x) {

	foreach ($x->link as $catlink) {
		
		 //&& ( $catlink['title'] == '[ more ]' )
		
		
		//echo $catlink['title'];
		if ( !empty ( $catlink['href'] ) && ( $catlink['title'] == '[ more ]' )){
		$category_name = explode ('/', $catlink['href']);
		$c = 0;
		
			
		if ( $category_name[3] != 'scripts' ){	
		
			//echo $category_name[3]."\n";
			array_push( $category_array, $category_name[3]  );
			//$category_id ++;
			
		}
		
		//exit();
		//$insert = $a_name;
		

		
		
		}
	}

}


$category_array = array_unique($category_array);

foreach ( $category_array as $category => $cname){

	//echo $first .' last='. $last;
	//exit();
	echo "<wp:category>\n\n";
	
	echo "<wp:term_id>".$category_id."</wp:term_id>\r\n";
	echo 		"<wp:category_nicename>".str_replace(' ','-',$cname)."</wp:category_nicename>\r\n";
	echo 		"<wp:category_parent>0</wp:category_parent>\r\n";
		echo		"<wp:category_name>".  ucfirst( $cname ) ."</wp:category_name>\r\n";
		echo "</wp:category>\r\n\n";
	
	$category_id++;
	
}


global $tag_array;

$tag_array = array();




foreach ($xml->entry as $x) {

	foreach ($x->category as $tagname) {
		
		 //&& ( $catlink['title'] == '[ more ]' )
		
		
		//echo $catlink['title'];
		if ( !empty ( $tagname['term'] ) && ( $tagname['label'] == 'ConTopic' )){
			array_push( $tag_array, $tagname['term']  );
		
		
		
		}
	}

}

/*

$tag_array = array_unique($tag_array);


foreach ( $tag_array as $tag => $tname){

	//echo $first .' last='. $last;
	//exit();
	echo "<wp:tag>\n\n";
	echo "<wp:term_id>".$tag_id."</wp:term_id>\r\n";
	
	

	echo "<wp:tag_slug>". strtolower( jb_slugs ( $tname ) )."</wp:tag_slug>\r\n";
	echo "<wp:tag_name>".  ucfirst( $tname ) ."</wp:tag_name>\r\n";
	echo "</wp:tag>\r\n\n";
	
	$tag_id++;
	
}


*/
echo '<generator>http://wordpress.org/?v=3.3.1</generator>';







/**
	
	Setup the content
	
	**/


foreach ($xml->entry as $x) {

echo "<item>";

echo "<title>".$x -> title."</title>\n\n";

echo "<pubDate>Mon, 06 Feb 2012 18:29:33 +0000</pubDate>\n\n";

echo "<dc:creator>" . $x -> author -> name . "</dc:creator>\n\n";

echo "<guid isPermaLink=\"false\">" . $x -> author -> name . "</guid>\n\n";

echo "<description>A</description>\n\n";

echo "<content:encoded><![CDATA[" . $x -> content . "]]></content:encoded>\n\n";

echo "<excerpt:encoded><![CDATA[" . $x -> summary . "]]></excerpt:encoded>\n\n\n";

// get psot id from source id stristr 
echo "<wp:post_id>". jb_postid ( $x-> source -> id )  ."</wp:post_id>\n\n";

echo "<wp:post_date>Mon, 13 Feb 2012 21:32:22 +0000</wp:post_date>\n\n";

echo "<wp:post_date_gmt>Mon, 13 Feb 2012 21:32:22 +0000</wp:post_date_gmt>\n\n";

echo "<wp:comment_status>open</wp:comment_status>\n\n";


// cleanup the title for a nice looking slug



echo "<wp:ping_status>open</wp:ping_status>\n
<wp:post_name>". strtolower( jb_slugs ( $x->title ) ) ."</wp:post_name>\n
<wp:status>publish</wp:status>\n
<wp:post_parent>0</wp:post_parent>\n
<wp:menu_order>0</wp:menu_order>\n
<wp:post_type>post</wp:post_type>\n
<wp:post_password></wp:post_password>\n
<wp:is_sticky>0</wp:is_sticky>\n\n";
		
		

echo "<category domain=\"post_tag\" nicename=\"". jb_puncfree( strtolower( jb_slugs ( $x -> title ) ) ) ."\"><![CDATA[" . jb_puncfree ( $x -> title ). "]]></category>\n\n";

echo "<category domain=\"category\" nicename=\"".strtolower( jb_slugs ( $x->category['term'] ) )."\"><![CDATA[".jb_puncfree ( $x->category['term'] )."]]></category>\n\n";


	/*	
	
		<wp:postmeta>
			<wp:meta_key>_edit_last</wp:meta_key>
			<wp:meta_value><![CDATA[1]]></wp:meta_value>
		</wp:postmeta>
		
	*/

echo "<wp:postmeta>\n\n";

echo "<wp:meta_key>_thumbnail_id</wp:meta_key>\n\n";

echo "<wp:meta_value><![CDATA[";


foreach ( $x-> link as $linktype ){




if ( $linktype['type'] == 'image/jpeg' ){

echo str_replace ( '.bin', '', jb_featureimage ( $linktype['href'] ) );

}


}

echo "]]></wp:meta_value>";

echo "</wp:postmeta>\n\n\r";



















echo "</item>\n\n\n\n\n\n\n";




// Setup the image attachment post









// grab the image number - used for title, image url attachment url etc.
foreach ( $x-> link as $linktype ){

	if ( $linktype['type'] == 'image/jpeg' ){
	
		$image_bin = str_replace ( '.bin', '', jb_featureimage ( $linktype['href'] ) );
	    $image_caption = $linktype['title'];
	}

}




?>


	
	
	
	
		<item>
		<title><?php echo $image_bin; ?> title</title>
        
		<link>http://localhost/dose2/?attachment_id=<?php echo $image_bin; ?></link>
        
		<pubDate>Mon, 06 Feb 2012 18:29:33 +0000</pubDate>
        
		<dc:creator>admin</dc:creator>
        
		<guid isPermaLink="false">http://localhost/dose2/parse/<?php echo $image_bin; ?>.jpg</guid>
        
		<description><?php echo $image_caption; ?></description>
        
		<content:encoded><![CDATA[ <?php echo $image_caption; ?> ]]></content:encoded>

		<excerpt:encoded><![CDATA[ <?php echo $image_caption; ?> ]]></excerpt:encoded>
        
		<wp:post_id><?php echo $image_bin; ?></wp:post_id>
        
		<wp:post_date>Mon, 06 Feb 2012 18:29:33 +0000</wp:post_date>
        
		<wp:post_date_gmt>Mon, 06 Feb 2012 18:29:33 +0000</wp:post_date_gmt>
        
		<wp:comment_status>open</wp:comment_status>
        
		<wp:ping_status>open</wp:ping_status>
		
        <wp:post_name><?php echo $image_bin; ?> post</wp:post_name>
		
        <wp:status>inherit</wp:status>
		
        <wp:post_parent>0</wp:post_parent>
		
        <wp:menu_order>0</wp:menu_order>
		
        <wp:post_type>attachment</wp:post_type>
		
        <wp:post_password></wp:post_password>
		
        <wp:is_sticky>0</wp:is_sticky>
		
        <wp:attachment_url>http://localhost/dose2/parse/<?php echo $image_bin; ?>.jpg</wp:attachment_url>
		
        <wp:postmeta>
			<wp:meta_key>_wp_attached_file</wp:meta_key>
			<wp:meta_value><![CDATA[2012/02/<?php echo $image_bin; ?>.jpg]]></wp:meta_value>
		</wp:postmeta>
        
		<wp:postmeta>
			<wp:meta_key>_wp_attachment_metadata</wp:meta_key>
			<wp:meta_value><![CDATA[a:6:{s:5:"width";s:3:"542";s:6:"height";s:3:"400";s:14:"hwstring_small";s:23:"height='94' width='128'";s:4:"file";s:14:"2012/02/<?php echo $image_bin; ?>.jpg";s:5:"sizes";a:5:{s:9:"thumbnail";a:3:{s:4:"file";s:14:"<?php echo $image_bin; ?>-150x150.jpg";s:5:"width";s:3:"150";s:6:"height";s:3:"150";}s:6:"medium";a:3:{s:4:"file";s:14:"<?php echo $image_bin; ?>-300x221.jpg";s:5:"width";s:3:"300";s:6:"height";s:3:"221";}s:14:"post-thumbnail";a:3:{s:4:"file";s:14:"<?php echo $image_bin; ?>-542x288.jpg";s:5:"width";s:3:"542";s:6:"height";s:3:"288";}s:13:"large-feature";a:3:{s:4:"file";s:14:"<?php echo $image_bin; ?>-542x288.jpg";s:5:"width";s:3:"542";s:6:"height";s:3:"288";}s:13:"small-feature";a:3:{s:4:"file";s:14:"<?php echo $image_bin; ?>-406x300.jpg";s:5:"width";s:3:"406";s:6:"height";s:3:"300";}}s:<?php echo $image_bin; ?>:"image_meta";a:<?php echo $image_bin; ?>:{s:8:"aperture";s:1:"0";s:6:"credit";s:0:"";s:6:"camera";s:0:"";s:7:"caption";s:0:"";s:17:"created_timestamp";s:1:"0";s:9:"copyright";s:0:"";s:12:"focal_length";s:1:"0";s:3:"iso";s:1:"0";s:13:"shutter_speed";s:1:"0";s:5:"title";s:0:"";}}]]></wp:meta_value>
		</wp:postmeta>
	</item>
	
	
	<?php 
	
	
	
}



























































/*




foreach ($xml->entry as $x) {
echo '<item>';
echo '<title>'.$x->title.'</title>';
echo '<pubDate>'.$x->published.'</pubDate>';
echo '<link>'.$x->link[0].'</link>';
echo '<dc:creator>'.$x->author->name.'</dc:creator>';

foreach ($x->category as $cat) {

	echo '<category domain="post_tag" nicename="'. strtolower($cat['term']).'"><![CDATA['.$cat['term'].']]></category>';

}

$linki = 0;
foreach ($x->link as $link) {
if ( $linki == 0 ){
	echo 'Abstract='.$link['Abstract'].'<br/>';
}
	if ($link['type']=='image/jpeg'){
		echo 'Link= <img src="http://www.dose.ca/'.$link['href'].'"/>-'.$link['Abstract'].'<br/>';
	}
	

	
	if (stristr($link['href'], 'photogallery', true)){
	
	
		//this will need to be converted into a scraper for photogalleries from the dose feed
		//echo '<h1>Photogallery= '.$link['href'].'</h1><br/>';
		
		
	}
	
		$linki++;
}

foreach ($x->content as $content) {


echo '<content:encoded><![CDATA[\''.$content->div.'\']]><content:encoded>';


}



echo '</item>';
}


*/
}
?>
</channel>
</rss>
